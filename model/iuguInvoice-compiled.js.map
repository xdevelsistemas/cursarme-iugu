{"version":3,"sources":["iuguInvoice.js"],"names":[],"mappings":"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","file":"iuguInvoice-compiled.js","sourcesContent":["'use strict';\nconst iugu = require('iugu');\nconst _ = require('lodash');\nconst multaPercentual = 2;\nlet format = require('string-format');\nformat.extend(String.prototype);\n\n\n// exemplo de boleto\n//{\n//    \"CodUnidade\": 215,\n//    \"CodMovimento\": \"-215021504130003\",\n//    \"intMesRef\": 1,\n//    \"Abatimento\": 0,\n//    \"Acréscimo\": 0,\n//    \"AcréscimoProgramado\": 0,\n//    \"AnoLcto\": null,\n//    \"AnoPgto\": null,\n//    \"AnoRef\": 2016,\n//    \"Bolsa\": 0,\n//    \"BolsaCondicional\": 18,\n//    \"Caixa\": \"Bradesco\",\n//    \"CréditoTerceiro\": 0,\n//    \"Curso\": \"Mestrado em Ciências da Educação\",\n//    \"CursoAbreviado\": \"Me. C. Educação\",\n//    \"MesLcto\": null,\n//    \"MesPgto\": null,\n//    \"MesRef\": \"01-Janeiro\",\n//    \"NomeAluno\": \"ELIANA CARDOSO DE SENA\",\n//    \"PagarValor\": 360,\n//    \"PagoData\": null,\n//    \"PagoValor\": 0,\n//    \"Parcela\": 20,\n//    \"QuitaçãoDescrição\": \"Manual\",\n//    \"TipoCobrança\": \"Mensalidade\",\n//    \"TurmaComplementoCompleta\": \"Turma 07\",\n//    \"ValorAberto\": 342,\n//    \"ValorCorrigido\": 342,\n//    \"ValorPagoCorrigido\": 342,\n//    \"Unidade\": \"Ieses / Cariacica\",\n//    \"Ajuizada\": false,\n//    \"Cancelada\": false,\n//    \"CodCaixa\": 6,\n//    \"ValorContabilizado\": 0,\n//    \"DataVencimento\": \"2016-01-15T00:00:00.000Z\"\n//}\n\nlet dataAtualFormatada = (data) => {\n    var dia = data.getDate();\n    if (dia.toString().length == 1)\n        dia = \"0\"+dia;\n    var mes = data.getMonth()+1;\n    if (mes.toString().length == 1)\n        mes = \"0\"+mes;\n    var ano = data.getFullYear();\n    return dia+\"/\"+mes+\"/\"+ano;\n};\n\n\nlet getInvoice = (unidade,invoiceId) => {\n    let iuguUnidade = iugu(unidade.key,'v1');\n\n    if (invoiceId){\n        return iuguUnidade.invoices.retrieve(invoiceId);\n    }else{\n        return Promise.resolve(null);\n    }\n};\n\n\nlet createInvoice = (unidade,boleto) => {\n    let iuguUnidade = iugu(unidade.key,'v1');\n    const today = new Date();\n    const vencimento = new Date(boleto.DataVencimento);\n    let itensInvoice = [];\n\n\n    let isLate = () => {\n        var timeDiff = vencimento - today;\n        var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));\n        return diffDays < 0\n    };\n\n    let price_cents = (valor) => {\n        //retornando em centavos no formato string\n        return Math.round(valor * 100).toString();\n    };\n\n\n    let addValorPrincipal = (list) => {\n        list.push({\n            description: \"{} Ref: {}/{} do Curso {}\".format(boleto.TipoCobrança, boleto.intMesRef, boleto.AnoRef, boleto.Curso),\n            quantity: \"1\",\n            price_cents: price_cents(boleto.ValorParcela).toString()\n        });\n\n        return list;\n\n    };\n\n\n    let addValorAcrescimo = (list) => {\n        if(boleto.Acréscimo > 0){\n            list.push({\n                description: \"Acréscimo: [{}]\".format(boleto.AcréscimoMotivo),\n                quantity: \"1\",\n                price_cents: price_cents(boleto.Acréscimo).toString()\n            });\n\n        }\n\n        return list;\n    };\n\n\n    let addValorAcrescimoProgramado = (list) => {\n        if(boleto.AcréscimoProgramado > 0){\n            list.push({\n                description: \"Acréscimo Programado: [{}]\".format(boleto.AcréscimoProgramadoMotivo),\n                quantity: \"1\",\n                price_cents: price_cents(boleto.AcréscimoProgramado).toString()\n            });\n\n        }\n\n        return list;\n    };\n\n    let addValorJuros = (list) => {\n        if(isLate() && boleto.JurosCorrigido > 0){\n            list.push({\n                description: \"Multa e Juros por atraso\",\n                quantity: \"1\",\n                price_cents: price_cents(boleto.JurosCorrigido).toString()\n            });\n\n        }\n\n        return list;\n    };\n\n\n\n    let addValorBolsa = (list) => {\n        let valor = Number(boleto.Bolsa);\n        valor  = valor > 0 ? valor *(-1) : valor;\n\n        if(valor != 0){\n            list.push({\n                description: \"Desconto: [{}]\".format(boleto.BolsaMotivo),\n                quantity: \"1\",\n                price_cents: price_cents(valor).toString()\n            });\n\n        }\n\n        return list;\n    };\n\n\n    let addValorBolsaCondicional = (list) => {\n        let valor = Number(boleto.BolsaCondicional);\n        valor  = valor > 0 ? valor *(-1) : valor;\n\n        if(valor != 0 && !isLate()){\n            list.push({\n                description: \"Desconto Condicionado ao Vencimento: [{}]\".format(boleto.BolsaCondicionalMotivo),\n                quantity: \"1\",\n                price_cents: price_cents(valor).toString()\n            });\n\n        }\n\n        return list;\n    };\n\n\n    let addValorAbatimento = (list) => {\n        let valor = Number(boleto.Abatimento);\n        valor  = valor > 0 ? valor *(-1) : valor;\n\n        if(valor != 0){\n            list.push({\n                description: \"Abatimento: [{}]\".format(boleto.AbatimentoMotivo),\n                quantity: \"1\",\n                price_cents: price_cents(valor).toString()\n            });\n\n        }\n\n        return list;\n    };\n\n    let getVencimento = () => dataAtualFormatada(isLate() ? today : vencimento);\n\n    let getEmail = () => {\n        let re = /^(([^<>()[\\]\\\\.,;:\\s@\"]+(\\.[^<>()[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/;\n        if (boleto.Email && re.test(boleto.Email)){\n            return boleto.Email;\n        }else{\n            return \"ieses@ieses.com\";\n        }\n    };\n\n    itensInvoice = addValorPrincipal(itensInvoice);\n    itensInvoice = addValorAcrescimo(itensInvoice);\n    itensInvoice = addValorAcrescimoProgramado(itensInvoice);\n    itensInvoice = addValorJuros(itensInvoice);\n    itensInvoice = addValorBolsa(itensInvoice);\n    itensInvoice = addValorBolsaCondicional(itensInvoice);\n    itensInvoice = addValorAbatimento(itensInvoice);\n\n    let objectInvoice = {\n        email: 'clayton@xdevel.com.br', //getEmail(), //todo colocar email na view\n        due_date: getVencimento(),\n        items: itensInvoice,\n        notification_url: 'https://cursarmeboleto.herokuapp.com/boletos/retorno/{}/{}/{}'.format(boleto.CodUnidade,boleto.CodMovimento,boleto.Parcela),\n        expired_url: 'https://cursarmeboleto.herokuapp.com/boletos/atrasado/{}/{}/{}'.format(boleto.CodUnidade,boleto.CodMovimento,boleto.Parcela), //todo ajustar a view de boleto atrasado para regerar\n        fines: \"true\",\n        late_payment_fine: multaPercentual.toString(),\n        discount_cents: \"0\",\n        per_day_interest: \"true\",\n        ignore_due_email: \"true\",\n        payable_with: 'bank_slip'\n    };\n\n    let calcTotal = (itens) => {\n        if (itens.length > 0) {\n            return _.sum(itens,'price_cents');\n        }else {\n            return 0;\n        }\n    };\n\n    if (calcTotal(itensInvoice) > 0) {\n        return iuguUnidade.invoices.create(objectInvoice)\n    }else {\n        throw new Error(\"O total do boleto é zero\");\n    }\n\n};\n\nlet cancelInvoice = (unidade,invoiceId) => {\n    let iuguUnidade = iugu(unidade.key,'v1');\n\n    if (invoiceId){\n        return iuguUnidade.invoices.cancel(invoiceId);\n    }else{\n        return Promise.resolve(null);\n    }\n};\n\n\n\nmodule.exports = {\n    createInvoice : createInvoice,\n    cancelInvoice : cancelInvoice,\n    getInvoice : getInvoice\n};\n\n\n\n\n\n\n"]}